---
title: 深入浅出小程序原理
date: 2018-04-13 17:47:12
tags: 小程序
---
>最近入职新公司负责小程序开发线的部分，有过vue的经历，其实微信的生态还是好上手的。就是得一点点的刨坑填坑，好在微信小程序的社区还算勤快，明显严重的bug官方会很快更新。之前已经写过一篇小程序的基础使用，那么这里就打算记录微信小程序的坑和底层原理东西啦～

### 小程序的由来
起初，微信中的 WebView 逐渐成为 web大部分的入口，微信就推出了相关的 JS API - WeixinJSBridge。再到后来的15年初，微信推出了 JS-SDK（对WeixinJSBridge的封装），开放了几十个有关拍照、地图等等非常有用的API。使得开发人员减轻了很多开发成本。虽然 JS-SDK的出现解决了功能逻辑上的许多大问题，却没有解决诸如复杂页面的白屏、页面切换卡顿等等性能上的问题。所以需要一个全新的系统，来优化这些问题，那么小程序应运而生。

### 小程序和传统web的区别
- web网页开发渲染线程和脚本是互斥的，而小程序对于两者是分开的，分别运行在不同的进程中。
- 小程序逻辑层和渲染层是分开的所以没有DOM、BOM，相关API也不能使用（所以好多第三方和dom有关的库也不能使用）

### 小程序运行环境

|运行环境| 逻辑层 | 渲染层
|--|--|--|
| iOS | JavaScriptCore | WKWebView
| Android| X5 JSCore | X5浏览器
| 小程序开发工具| NWJS | Chrome WebView

### 宿主环境
小程序可以调用宿主环境提供的微信客户端的能力，这就使得小程序比普通网页拥有更多的能力。
- **通信模型**
小程序的渲染层和逻辑层分别由两个进程管理，通信会由微信客户端做中转。
- **数据驱动**
数据驱动使得数据状态和视图绑定在一起,wxml文件对应着一个js对象，可以假使这是一个dom树，当数据变化时，直接修改dom树对应的js对象，wxml对比js对象前后的差别然后进行部分渲染。这个原理听起来很熟悉嘛？是的，和vue、react的虚拟DOM大同小异，都是为了避免重复渲染“dom”做的优化。
- **全局数据**
因为渲染层和逻辑层的分离，没打开一个页面都会各自又一个 WebView进程进行渲染，在逻辑层的JS脚本运行上下文依旧在一个进程中没有变。所以App里的globalData是可以全局获取到的喔😯

### 
